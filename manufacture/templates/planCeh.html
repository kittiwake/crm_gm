{% extends "base.html" %}
{% block title %}
–ü–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
{% endblock title %}

{% block content %}
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f7f9fc;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-style: italic;
            margin-bottom: 20px;
        }

        /* –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è */
        .production-schedule {
            overflow-x: auto;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            vertical-align: top;
        }

        th {
            background-color: #f0f4f8;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .stage-name {
            font-weight: bold;
            background-color: #e3f2fd !important;
            text-align: left;
        }

        /* –ë–µ–π–¥–∂ –∑–∞–∫–∞–∑–∞ */
        .order-badge {
            display: inline-block;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 6px 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: move;
            transition: background 0.2s;
        }

        .order-badge:hover {
            background-color: #bbdefb;
        }

        .order-time {
            font-size: 0.8em;
            color: #555;
            display: block;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ç–∞–ø–æ–≤ */
        .stage-load {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }

        .stage-load-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            width: 220px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .stage-load-item h4 {
            margin: 0 0 10px;
            color: #1976d2;
        }

        .load-bar {
            background: #eee;
            height: 20px;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }

        .load-fill {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            height: 100%;
            border-radius: 10px;
            text-align: center;
            color: white;
            font-size: 12px;
            line-height: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .orders-list {
            font-size: 0.85em;
            margin-top: 8px;
        }

        .order-item {
            padding: 4px 0;
            border-bottom: 1px dashed #eee;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ —Å —Ç–∞–π–º–ª–∞–π–Ω–æ–º */
        .order-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .order-header h4 {
            margin: 0;
            color: #1976d2;
        }

        .order-client {
            color: #666;
            font-size: 0.9em;
        }

        .order-stages-timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
        }

        .stage-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
            text-align: center;
        }

        .stage-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            margin-bottom: 6px;
            background-color: #e0e0e0;
            color: #555;
        }

        .stage-indicator.completed .stage-icon {
            background-color: #4caf50;
            color: white;
        }

        .stage-indicator.current .stage-icon {
            background-color: #ffeb3b;
            color: #333;
        }

        .stage-date {
            font-size: 0.8em;
            margin-top: 4px;
            color: #666;
        }

        .timeline-connector {
            flex-grow: 1;
            height: 2px;
            background-color: #ddd;
            margin: 0 5px;
        }

        /* –¶–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ */
        .stage-status-planned { background-color: #bbdefb; border-left: 4px solid #2196f3; }
        .stage-status-inprogress { background-color: #fff9c4; border-left: 4px solid #ffeb3b; }
        .stage-status-completed { background-color: #c8e6c9; border-left: 4px solid #4caf50; }
        .stage-status-delayed { background-color: #ffcdd2; border-left: 4px solid #f44336; }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .stage-load {
                flex-direction: column;
                align-items: stretch;
            }
            .stage-load-item {
                width: 100%;
            }
            table {
                font-size: 0.9em;
            }
            .order-badge {
                font-size: 0.8em;
            }
        }
    </style>


    <h1>–ü–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h1>
    <p class="subtitle">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∑–∞–∫–∞–∑—ã –º–µ–∂–¥—É —è—á–µ–π–∫–∞–º–∏ –¥–ª—è –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
    <div class="production-schedule">
<table>
    <thead>
        <tr>
            <th>–≠—Ç–∞–ø</th>
            {% for date in dates %}
                <th>{{ date.day_month }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for etap in etap_list %}
<tr>
    <td class="stage-name">{{ etap.title }}</td>
    
    {% for date in dates %}
    <td class="time-slot" data-stage="{{ etap.id }}" data-date="{{ date.full|date:'Y-m-d' }}">
        {% for order_etap in object_list %}
            {% if order_etap.etap.id == etap.id and order_etap.date == date.full %}
            <div class="order-badge stage-status-{{ order_etap.status }}" data-order-id="{{ order_etap.order.id }}">
                {{ order_etap.order.contract }}
                {% if order_etap.responsible %}
                    <br><small>{{ order_etap.responsible.last_name }}</small>
                {% endif %}
            </div>
            {% endif %}
        {% endfor %}
    </td>
    {% endfor %}
</tr>
        {% endfor %}
    </tbody>
</table>

</div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ç–∞–ø–æ–≤ -->
    <div class="stage-load">
        <div class="stage-load-item">
            <h4>–ü—Ä–æ—Å—á–µ—Ç</h4>
            <div class="load-bar">
                <div class="load-fill" style="width: 60%">2/3</div>
            </div>
            <div class="orders-list">
                <div class="order-item">#ORD-1001 - 10:00</div>
                <div class="order-item">#ORD-1002 - 14:00</div>
            </div>
        </div>

        <div class="stage-load-item">
            <h4>–†–∞—Å–ø–∏–ª</h4>
            <div class="load-bar">
                <div class="load-fill" style="width: 40%">1/5</div>
            </div>
            <div class="orders-list">
                <div class="order-item">#ORD-1001 - 08:00-12:00</div>
            </div>
        </div>

        <div class="stage-load-item">
            <h4>–ö—Ä–æ–º–∫–æ–≤–∞–Ω–∏–µ</h4>
            <div class="load-bar">
                <div class="load-fill" style="width: 20%">1/8</div>
            </div>
            <div class="orders-list">
                <div class="order-item">#ORD-1001 - 13:00-15:00</div>
            </div>
        </div>

        <div class="stage-load-item">
            <h4>–°–≤–µ—Ä–ª–æ–≤–∫–∞</h4>
            <div class="load-bar">
                <div class="load-fill" style="width: 15%">1/10</div>
            </div>
            <div class="orders-list">
                <div class="order-item">#ORD-1001 - 15:00-17:00</div>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–∏–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞ -->
    <div class="order-card">
        <div class="order-header">
            <h4>–ó–∞–∫–∞–∑ #ORD-1001</h4>
            <span class="order-client">–ò–≤–∞–Ω–æ–≤ –ê.–ê.</span>
        </div>
        <div class="order-stages-timeline">
            <div class="stage-indicator completed">
                <div class="stage-icon">üìù</div>
                <div class="stage-date">16.04</div>
            </div>
            <div class="timeline-connector"></div>
            <div class="stage-indicator current">
                <div class="stage-icon">‚úÇÔ∏è</div>
                <div class="stage-date">17.04</div>
            </div>
            <div class="timeline-connector"></div>
            <div class="stage-indicator">
                <div class="stage-icon">üîß</div>
                <div class="stage-date">18.04</div>
            </div>
            <div class="timeline-connector"></div>
            <div class="stage-indicator">
                <div class="stage-icon">ü™õ</div>
                <div class="stage-date">19.04</div>
            </div>
            <div class="timeline-connector"></div>
            <div class="stage-indicator">
                <div class="stage-icon">üì¶</div>
                <div class="stage-date">20.04</div>
            </div>
            <div class="timeline-connector"></div>
            <div class="stage-indicator">
                <div class="stage-icon">üöö</div>
                <div class="stage-date">21.04</div>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Drag & Drop
        document.addEventListener('DOMContentLoaded', function() {
            const orderBadges = document.querySelectorAll('.order-badge');
            const timeSlots = document.querySelectorAll('.time-slot');

            orderBadges.forEach(badge => {
                badge.draggable = true;
                badge.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('order-id', this.dataset.orderId);
                    this.style.opacity = '0.6';
                });

                badge.addEventListener('dragend', function() {
                    this.style.opacity = '1';
                });
            });

            timeSlots.forEach(slot => {
                slot.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });

                slot.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const orderId = e.dataTransfer.getData('order-id');
                    const orderBadge = document.querySelector(`.order-badge[data-order-id="${orderId}"]`);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –∑–∞–∫–∞–∑ –≤ —è—á–µ–π–∫–µ
                    const existing = this.querySelector(`.order-badge[data-order-id="${orderId}"]`);
                    if (!existing && orderBadge) {
                        // –ö–ª–æ–Ω–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
                        const clone = orderBadge.cloneNode(true);
                        clone.addEventListener('dragstart', function(e) {
                            e.dataTransfer.setData('order-id', this.dataset.orderId);
                            this.style.opacity = '0.6';
                        });
                        clone.addEventListener('dragend', function() {
                            this.style.opacity = '1';
                        });
                        this.appendChild(clone);
                    }
                });
            });

            console.log("Drag & Drop –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
        });
    </script>

{% endblock content %}
